<!DOCTYPE html>
<html>
<head>
    <title>Select Crop Area</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: Arial; }

        .container {
            display: flex;
            height: 100vh;
        }

        /* LEFT - Map Section */
        #map {
            width: 70%;
            height: 100%;
        }

        /* RIGHT - Output Panel */
        #output-panel {
            width: 30%;
            padding: 15px;
            background: #f5f5f5;
            border-left: 2px solid #ddd;
            overflow-y: auto;
        }

        .back-btn {
            position: absolute;
            z-index: 9999;
            top: 20px;
            left: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            border: 1px solid #ccc;
        }

        pre {
            white-space: pre-wrap;
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

<button class="back-btn" onclick="window.location.href='/'">
    ‚Üê Back to Dashboard
</button>

<div class="container">

    <!-- LEFT: MAP -->
    <div id="map"></div>

    <!-- RIGHT: OUTPUT -->
    <div id="output-panel">
        <h2>Drone Data Inside Polygon</h2>
        <p>Select any area on map to get drone list.</p>
        <pre id="map-output">Waiting for selection...</pre>
    </div>

</div>

<script>
function initMap() {
    const map = L.map("map").setView([20.5937, 78.9629], 5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        draw: {
            polyline: false,
            circle: false,
            marker: false,
            rectangle: false,
            circlemarker: false,
            polygon: true
        },
        edit: { featureGroup: drawnItems }
    });

    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, async function (event) {
        const layer = event.layer;
        drawnItems.addLayer(layer);

        const coords = layer.getLatLngs()[0].map(pt => [pt.lat, pt.lng]);

        document.getElementById("map-output").textContent =
            "üì° Saving polygon...";

        // SAVE POLYGON FIRST
        const polygonResponse = await fetch("/store_polygon", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ coords })
        });

        const polygonResult = await polygonResponse.json();

        // GET polygon_id
        const polygon_id = polygonResult.polygon_id;

        // NOW FETCH DRONES INSIDE THE POLYGON
        const droneRes = await fetch(`/drones_in_polygon?polygon_id=${polygon_id}`);
        const droneData = await droneRes.json();

        document.getElementById("map-output").textContent =
            JSON.stringify(droneData, null, 2);
    });
}

document.addEventListener("DOMContentLoaded", initMap);
</script>

</body>
</html>
